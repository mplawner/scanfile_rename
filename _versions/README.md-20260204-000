# scanfile_rename

Rename scanned PDF documents by extracting metadata (date/provider/type/title) and generating a human-readable filename.

This script:
- Extracts text with `pdftotext` (Poppler)
- Falls back to a vision pass (renders pages to images with `pdftoppm` and sends them to LM Studio)
- Copies (or moves) the PDF to an output directory using the proposed filename

## Quick Start

1) Install dependencies (macOS/Homebrew):

```bash
brew install poppler ghostscript
```

2) Ensure LM Studio is running with an OpenAI-compatible endpoint.

3) Run:

```bash
python3 scanfile_rename.py "path/to/input.pdf"
```

The script prints a proposed filename and copies the PDF to `processed/` next to the input file by default.

## Usage

```bash
python3 scanfile_rename.py <pdf> [--outdir DIR] [--move] [--dry-run] [--print-json] [--no-progress] [--no-repair] [--lm-timeout SEC] [--lm-retries N] [--version]
```

Options:
- `--outdir DIR`: destination directory (default: `<input_dir>/processed`)
- `--move`: move instead of copy
- `--dry-run`: print proposed filename, do not write
- `--print-json`: print extracted JSON (useful for debugging)
- `--no-progress`: disable progress output
- `--no-repair`: disable qpdf/ghostscript repair attempts
- `--lm-timeout SEC`: LM Studio request timeout in seconds
- `--lm-retries N`: LM Studio retry count for network/server errors
- `--version`: print version and exit

Examples:

```bash
# Dry run (no file written)
python3 scanfile_rename.py "scan.pdf" --dry-run

# Copy into a specific directory
python3 scanfile_rename.py "scan.pdf" --outdir "./renamed"

# Move (destructive)
python3 scanfile_rename.py "scan.pdf" --move

# Debug: show extracted fields
python3 scanfile_rename.py "scan.pdf" --print-json
```

## Progress Output

The script prints progress steps to stdout (text extraction, image rendering, LM Studio calls, file copy/move).

When `--print-json` is used and stdout is not a TTY (e.g. piping to a file), progress output is automatically disabled to keep JSON clean.

To force progress even when piping, set:

```bash
FORCE_PROGRESS=1 python3 scanfile_rename.py "scan.pdf" --print-json | tee out.json
```

## Configuration (Environment Variables)

- `LM_STUDIO_ENDPOINT` (default: `http://localhost:1234/v1/chat/completions`)
- `LM_STUDIO_MODEL` (default: `qwen3-vl-8b-instruct`)
- `LM_STUDIO_TIMEOUT` (default: `120` seconds)
- `LM_STUDIO_MAX_RETRIES` (default: `0`)
- `PDFTOTEXT` (default: `/opt/homebrew/bin/pdftotext`)
- `PDFTOPPM` (default: `/opt/homebrew/bin/pdftoppm`)
- `GS` (default: `/opt/homebrew/bin/gs`)  (Ghostscript)
- `QPDF` (default: `/opt/homebrew/bin/qpdf`) (optional)

Tuning:
- `VISION_MAX_PAGES` (default: `3`)
- `VISION_DPI` (default: `200`)
- `MIN_TEXT_CHARS` (default: `200`)

CLI flags override the LM Studio timeout/retry environment defaults.

## Handling Corrupt PDFs

If Poppler fails with errors like:
- `Couldn't find trailer dictionary`
- `Couldn't read xref table`

The script will automatically try to repair/rewrite the PDF before re-running text/vision extraction:
- `qpdf --repair` (if installed)
- Ghostscript `pdfwrite` rewrite (if installed)

Install helpers:

```bash
brew install qpdf ghostscript
```

## Notes

- Output filenames are sanitized and de-duplicated (`... (2).pdf`, etc.).
- Vision mode sends rendered page images to your LM Studio endpoint.

## Testing

```bash
python3 -m unittest
```
