# scanfile_rename

Rename scanned PDFs into human-readable filenames by extracting key fields (date, provider, document type, title). Text extraction runs first; if the PDF has little or no text, the tool can fall back to a vision pass via LM Studio.

## Key features

- Text-first extraction using Poppler `pdftotext`
- Vision fallback: render pages with Poppler `pdftoppm` and call an OpenAI-compatible LM Studio endpoint
- Copy (default) or move into an output directory; filenames are sanitized and de-duplicated
- Optional best-effort repair for some broken PDFs (qpdf/ghostscript)
- Best-effort PDF metadata enrichment via `pypdf` (classic DocumentInfo, not XMP)
- `--print-json` for debugging extracted fields

## Requirements

- Python 3.12 recommended
- System tools:
  - Required: Poppler (`pdftotext`, `pdftoppm`)
  - Optional (PDF repair helpers): `ghostscript` (`gs`), `qpdf`

macOS/Homebrew:

```bash
brew install poppler
brew install ghostscript qpdf
```

## Install

```bash
python3 -m venv .venv
source .venv/bin/activate
python3 -m pip install -r requirements.txt
```

## Usage

Basic run (copies into `processed/` next to the input PDF by default):

```bash
python3 scanfile_rename.py "path/to/input.pdf"
```

More examples:

```bash
# Dry run (no file written)
python3 scanfile_rename.py "scan.pdf" --dry-run

# Copy into a specific directory
python3 scanfile_rename.py "scan.pdf" --outdir "./renamed"

# Move (destructive)
python3 scanfile_rename.py "scan.pdf" --move

# Debug: show extracted fields as JSON
python3 scanfile_rename.py "scan.pdf" --print-json
```

## Options

All flags below match `scanfile_rename.py`'s `argparse` setup:

- `--outdir DIR`: destination directory (default: `<input_dir>/processed`)
- `--move`: move instead of copy
- `--dry-run`: print the proposed filename, do not write a file
- `--print-json`: print extracted JSON (useful for debugging)
- `--no-progress`: disable progress output
- `--no-repair`: disable qpdf/ghostscript repair attempts
- `--keywords-count N`: number of keywords to include (default: 5)
- `--lm-timeout SEC`: LM Studio request timeout in seconds
- `--lm-retries N`: LM Studio max retries on network/server errors
- `--version`: print version and exit

## Configuration

Environment variables (defaults shown):

- `LM_STUDIO_ENDPOINT` = `http://localhost:1234/v1/chat/completions` (OpenAI-compatible)
- `LM_STUDIO_MODEL` = `qwen3-vl-8b-instruct`
- `LM_STUDIO_TIMEOUT` = `120`
- `LM_STUDIO_MAX_RETRIES` = `0`
- `PDFTOTEXT` = `/opt/homebrew/bin/pdftotext`
- `PDFTOPPM` = `/opt/homebrew/bin/pdftoppm`
- `GS` = `/opt/homebrew/bin/gs`
- `QPDF` = `/opt/homebrew/bin/qpdf`

Tuning:

- `VISION_MAX_PAGES` (default: 3)
- `VISION_DPI` (default: 200)
- `MIN_TEXT_CHARS` (default: 200)

Notes:

- CLI flags override the LM Studio timeout/retry environment defaults.
- When `--print-json` is used and stdout is not a TTY (piping to a file), progress output is automatically disabled to keep JSON clean. Set `FORCE_PROGRESS=1` to force progress output while piping.

## Metadata enrichment behavior

After the output file is written (post copy/move), the tool attempts to enrich classic PDF DocumentInfo metadata (Info dictionary, not XMP) using `pypdf`.

- Writes DocumentInfo keys like `/Title`, `/Author`, `/Subject`, `/Keywords`, `/CreationDate`, `/ModDate`
- Values are derived from extracted info plus local formatting helpers (for example, `/Title` is derived from the output filename)
- Skips metadata writing when the PDF appears encrypted or signed
- Best-effort: failures do not change the exit code

## Development and testing

```bash
python3 -m unittest discover -s tests
python3 -m unittest tests.test_core
```

## Troubleshooting

- Poppler tools not found: install Poppler and/or set `PDFTOTEXT` / `PDFTOPPM` to the correct executable paths.
- LM Studio connection errors: ensure LM Studio is running and `LM_STUDIO_ENDPOINT` is reachable; the default is `http://localhost:1234/v1/chat/completions`.
- Corrupt PDFs (Poppler syntax errors): install `qpdf` and/or `ghostscript` and avoid `--no-repair`.
- Encrypted or signed PDFs: the tool will still rename/copy/move the PDF, but metadata writing is skipped.
