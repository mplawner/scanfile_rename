# OpenCode Agent Guide

This repo is a small Python CLI for renaming scanned PDFs.

## Project Overview

- Primary script: `scanfile_rename.py`
- Older variants live under `_versions/` (avoid editing unless asked).

Pipeline (high level):
1) Extract text via Poppler `pdftotext`
2) If needed, render pages via Poppler `pdftoppm` and call LM Studio (OpenAI-compatible endpoint)
3) Build a sanitized filename and copy/move the PDF into an output directory

## Local Dev Setup

macOS (Homebrew):

```bash
brew install poppler ghostscript
```

Optional (PDF repair):

```bash
brew install qpdf
```

LM Studio must be running and reachable via `LM_STUDIO_ENDPOINT`.

## Commands (Build, Lint, Test)

There is no formal build system configured in this repo.

- Lint / syntax check (required for changes):
  - `python3 -m py_compile scanfile_rename.py`
- Tests:
  - `python3 -m unittest discover -s tests`
- Manual run (CLI behavior check):
  - `python3 scanfile_rename.py "path/to/input.pdf"`
  - `python3 scanfile_rename.py "scan.pdf" --dry-run`
  - `python3 scanfile_rename.py "scan.pdf" --print-json`

Single-test invocation:
- `python3 -m unittest tests.test_core`

If you add tests in the future, also document:
- How to run the full suite
- How to run a single test file or test case

## How To Run

```bash
python3 scanfile_rename.py "path/to/input.pdf"
```

Useful flags:

```bash
python3 scanfile_rename.py "scan.pdf" --dry-run
python3 scanfile_rename.py "scan.pdf" --print-json
python3 scanfile_rename.py "scan.pdf" --no-progress
```

## Environment Variables

- `LM_STUDIO_ENDPOINT` (default: `http://localhost:1234/v1/chat/completions`)
- `LM_STUDIO_MODEL` (default: `qwen3-vl-8b-instruct`)
- `LM_STUDIO_TIMEOUT` (default: `120` seconds)
- `LM_STUDIO_MAX_RETRIES` (default: `0`)
- `PDFTOTEXT`, `PDFTOPPM` (Poppler paths)
- `GS` (Ghostscript path)
- `QPDF` (qpdf path)
- `VISION_MAX_PAGES`, `VISION_DPI`, `MIN_TEXT_CHARS`
- `FORCE_PROGRESS=1` to keep progress output when piping JSON

## Agent Workflow Expectations

- Prefer minimal, targeted diffs.
- Whenever you change a file, also save a copy to `_versions/` named `{filename}-YYYYMMDD-###` with the numeric suffix incremented for that day.
- Keep stdout stable; if adding output, consider `--no-progress` / `--print-json` interactions.
- Avoid adding new dependencies unless necessary.
- Standard library only unless explicitly required.
- Preserve ASCII-only text unless the file already uses Unicode.
- For any code change, run at least:

```bash
python3 -m py_compile scanfile_rename.py
```

## Code Style Guide

These conventions are inferred from `scanfile_rename.py` and should be followed.

### Imports

- Prefer a single comma-separated stdlib import line when adding only stdlib modules.
- Do not add third-party dependencies unless explicitly required.
- Local imports are avoided; everything is in a single script.

### Formatting

- Indent with 4 spaces.
- Compact one-line conditionals are common (e.g., `if not x: return ...`).
- Module-level constants use tight `NAME=value` formatting (no spaces around `=`).
- f-strings are preferred for string formatting.
- Keep helper functions small and single-purpose.

### Naming

- Functions and variables: `snake_case`.
- Internal helpers: leading underscore (e.g., `_progress`, `_render_pdf_to_images`).
- Constants: `UPPER_SNAKE_CASE`.

### Error Handling

- Use explicit errors for tool failures (e.g., `RuntimeError` when `pdftoppm` fails).
- Return tuples for internal helpers when useful (e.g., `(text, rc, err)`).
- Avoid swallowing errors silently; log a short message via `_progress` or `print`.
- If a subprocess fails, include return code and a short snippet of stderr/stdout.

### CLI and Output

- CLI is built with `argparse` in `main()`.
- Flags use `--kebab-case` style (e.g., `--dry-run`, `--print-json`).
- `_progress()` is used for step logging; normal output uses `print()`.
- Keep stdout machine-readable when `--print-json` is used and stdout is not a TTY.
- Avoid adding noisy output or changing existing message formats.

### File and Path Handling

- Use `os.path` and `tempfile` (no `pathlib` currently).
- Use `shutil.copy2` for copying and `shutil.move` for moving.
- Sanitize filenames with `_safe_filename` and de-duplicate with `_unique_path`.

### Data Handling

- JSON parsing is tolerant (`_extract_json_loose`).
- Use defensive parsing and normalization for dates and document types.
- Avoid adding large dependencies for parsing or NLP.

## Repo Structure Notes

- `scanfile_rename.py` is the only active script.
- `_versions/` contains snapshots; treat as historical reference.

## Cursor / Copilot Rules

- No `.cursor/rules/`, `.cursorrules`, or `.github/copilot-instructions.md` files were found.
- If any of these are added later, mirror their guidance here.

## Quick Reference

- Run CLI: `python3 scanfile_rename.py "path/to/input.pdf"`
- Dry run: `python3 scanfile_rename.py "scan.pdf" --dry-run`
- JSON output: `python3 scanfile_rename.py "scan.pdf" --print-json`
- Syntax check: `python3 -m py_compile scanfile_rename.py`
